<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovaci√≥n con Clase - Presentaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #E5E7EB;
            overflow: hidden;
        }
        main {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(90deg, #38bdf8, #a78bfa, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .content-card, .quiz-card, .diagnostico-card, .taller-card {
            background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border-radius: 1.5rem;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-button .icon {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-button.active .icon {
            transform: rotate(180deg);
        }
        
        .tab-button {
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .tab-button.active {
            background-color: #38bdf8;
            color: white;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
        }
        .tab-button.inactive {
            background-color: rgba(30, 41, 59, 0.5);
            color: #9ca3af;
            border-color: rgba(255, 255, 255, 0.1);
        }
        select, textarea, input[type="text"], input[type="password"] {
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.7rem 1rem;
            background-color: #111827;
            color: #e5e7eb;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        select:focus, textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3);
        }
        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Aligns content to the top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.6s ease-in-out, visibility 0.6s ease-in-out;
            padding: 2rem 1rem;
            overflow-y: auto; /* Allows scrolling within the slide */
        }
        .slide-center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        .slide.active {
            opacity: 1;
            visibility: visible;
            z-index: 10;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
        }

        .dice-option.selected {
            background-color: #38bdf8 !important;
            color: #ffffff;
            transform: scale(1.05);
            box-shadow: 0 0 10px #38bdf8;
        }
        
        #password-modal {
            transition: opacity 0.3s ease-in-out;
        }
        
        .mood-selector, .perception-button {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        .mood-selector.selected, .perception-button.selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px #38bdf8;
            background-color: #38bdf8 !important;
            color: white;
        }
        .tree-placeholder {
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .tree-placeholder:hover {
            background-color: rgba(56, 189, 248, 0.2);
            transform: scale(1.1);
        }
        #progress-dots {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 30;
        }
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s;
        }
        .progress-dot.active {
            background-color: #38bdf8;
        }


        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes dice-roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(15deg) scale(1.1); }
            50% { transform: rotate(-15deg) scale(1.1); }
            75% { transform: rotate(5deg) scale(1.05); }
            100% { transform: rotate(0deg) scale(1); }
        }
        .dice-roll-animation {
            animation: dice-roll 0.5s ease-in-out;
        }
        .text-justify {
            text-align: justify;
        }
        #plexus-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .assessment-screen {
             display: none;
             animation: fadeIn 0.5s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">
    <canvas id="plexus-bg"></canvas>
    <main>
        <!-- Slide 1: Portada -->
        <section id="portada" class="slide bg-cover bg-center" style="background-image: url('https://i.imgur.com/VY7kQ41.png');">
            <div id="init-status" class="fixed top-5 left-5 bg-gray-900/80 text-white text-xs p-2 rounded-lg z-50 transition-opacity duration-500"></div>
            <div class="absolute inset-0 bg-black/80"></div>
            <div class="relative z-10 container mx-auto max-w-5xl text-center flex flex-col items-center justify-center h-full">
                <div class="animate-fade-in" style="animation: fadeIn 1s ease-out forwards;">
                    <p class="font-orbitron text-2xl md:text-3xl text-gray-300 mb-4">Comfamiliar Risaralda</p>
                    <h1 class="font-orbitron text-4xl md:text-6xl font-black tracking-wider uppercase"><span class="gradient-text">Interacci√≥n Inmersiva de Gesti√≥n del Cambio</span></h1>
                    <div class="mt-8 border-t border-b border-sky-500/30 py-4 max-w-3xl mx-auto">
                        <p class="text-lg md:text-xl text-gray-200 font-semibold">Gerencia de la Innovaci√≥n</p>
                        <p class="text-lg md:text-xl text-gray-200 mt-2 font-semibold">ADMINISTRACI√ìN DE EMPRESAS</p>
                    </div>
                </div>
                <div class="mt-16" style="animation: fadeIn 1s 0.4s ease-out forwards; opacity: 0;">
                    <p class="text-xl md:text-2xl text-gray-300 font-semibold">17 de Febrero, 2026</p>
                </div>
            </div>
            <button id="cover-next-btn" class="fixed bottom-10 right-10 z-20 p-3 rounded-full bg-sky-500/50 text-white shadow-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400 transition-all duration-300"><i class="fas fa-chevron-right text-xl"></i></button>
        </section>
        
        <!-- Slide 2: Team Mood -->
        <section id="team-mood" class="slide">
            <div id="team-mood-content" class="container mx-auto max-w-6xl w-full"></div>
        </section>

        <!-- Slide 3: Mindset -->
        <section id="mindset" class="slide">
             <div id="mindset-content" class="container mx-auto max-w-4xl w-full content-card p-6 md:p-8"></div>
        </section>

        <!-- Slide 4: Ideaci√≥n -->
        <section id="ideacion" class="slide">
            <div id="ideacion-content" class="container mx-auto max-w-4xl w-full content-card p-6 md:p-8"></div>
        </section>
        
        <!-- Slide 5: Assessment de Pensamiento -->
        <section id="pensamiento-assessment" class="slide">
            <div id="pensamiento-assessment-content" class="container mx-auto max-w-4xl w-full"></div>
        </section>

        <!-- Slide 6: Assessment de Cambio -->
        <section id="assessment" class="slide">
             <div id="assessment-content" class="container mx-auto max-w-5xl w-full"></div>
        </section>

        <!-- Slide 7: Taller -->
        <section id="taller" class="slide">
             <div id="taller-content" class="container mx-auto max-w-6xl w-full"></div>
        </section>
        
        <!-- Slide 8: Final -->
        <section id="final" class="slide">
             <div id="final-content" class="container mx-auto max-w-4xl w-full text-center flex flex-col items-center justify-center h-full"></div>
        </section>

        <!-- Navigation Buttons -->
        <button id="prevBtn" class="fixed bottom-10 left-10 z-20 p-3 rounded-full bg-sky-500/50 text-white shadow-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400 transition-all duration-300 hidden"><i class="fas fa-chevron-left text-xl"></i></button>
        <button id="nextBtn" class="fixed bottom-10 right-10 z-20 p-3 rounded-full bg-sky-500/50 text-white shadow-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400 transition-all duration-300 hidden"><i class="fas fa-chevron-right text-xl"></i></button>
        
        <!-- Fullscreen Button -->
        <button id="fullscreenBtn" class="fixed bottom-10 right-28 z-20 p-3 rounded-full bg-sky-500/50 text-white shadow-lg hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-400 transition-all duration-300">
            <i class="fas fa-expand text-xl"></i>
        </button>

        <!-- Progress Dots -->
        <div id="progress-dots"></div>
    </main>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden opacity-0">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm text-center border border-sky-500/30">
            <h3 class="font-bold text-xl mb-4 text-white">Acci√≥n Protegida</h3>
            <p class="text-gray-400 mb-6">Por favor, introduce la contrase√±a para continuar.</p>
            <input type="password" id="password-input" class="w-full text-center" placeholder="********">
            <p id="password-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <div class="mt-6 flex gap-4">
                <button id="password-cancel" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="password-submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ========= CONFIGURACI√ìN DE FIREBASE INSERTADA AQU√ç ========= -->
    <script>
      // 1. Tu configuraci√≥n de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCHBOA0tixmSnoxABwwVWoxrXsBljvomNA",
        authDomain: "mentalidad-7752e.firebaseapp.com",
        projectId: "mentalidad-7752e",
        storageBucket: "mentalidad-7752e.firebasestorage.app",
        messagingSenderId: "485164590441",
        appId: "1:485164590441:web:0161a806a16577977ac9f8",
        measurementId: "G-2SC4L6MQ56"
      };

      // 2. Esto crea las variables que tu script principal (el "module") est√° esperando
      var __firebase_config = JSON.stringify(firebaseConfig);
      
      // 3. Define un ID √∫nico para esta sesi√≥n. Puedes cambiarlo si quieres.
      var __app_id = 'sesion-comfamiliar-2025'; 
    </script>
    <!-- ============================================================= -->

<script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, getDocs, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase and global variables
    let db, auth, userId, appId;

    function waitForFirebaseConfig(timeout = 5000) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();
            const interval = setInterval(() => {
                if (typeof __firebase_config !== 'undefined' && typeof __app_id !== 'undefined') {
                    clearInterval(interval);
                    resolve();
                } else if (Date.now() - startTime > timeout) {
                    clearInterval(interval);
                    reject(new Error("La configuraci√≥n de Firebase o el App ID no estuvieron disponibles a tiempo."));
                }
            }, 100);
        });
    }

    window.onload = async () => {
        const statusEl = document.getElementById('init-status');
        statusEl.textContent = 'Estado: Iniciando...';
        
        let isConnected = false;
        try {
            statusEl.textContent = 'Estado: Esperando configuraci√≥n...';
            await waitForFirebaseConfig();

            statusEl.textContent = 'Estado: Configuraci√≥n recibida. Autenticando...';
            await initializeAndAuth();
            
            statusEl.textContent = 'Estado: Conectado. ¬°Listo!';
            setTimeout(() => {
                statusEl.style.opacity = 0;
                setTimeout(() => statusEl.classList.add('hidden'), 500);
            }, 2000);
            isConnected = true;

        } catch (error) {
            console.error("Falla detallada de inicializaci√≥n:", { 
                message: error.message, 
                code: error.code, 
                stack: error.stack 
            });
            statusEl.textContent = `Error: ${error.message}`;
            statusEl.style.backgroundColor = 'rgba(127, 29, 29, 0.8)'; // bg-red-900 with opacity
            statusEl.style.border = '1px solid #ef4444';
        }
        runApp(isConnected);
    };


    async function initializeAndAuth() {
        const firebaseConfig = JSON.parse(__firebase_config);
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            await new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, user => {
                    unsubscribe(); 
                    if (user) {
                        userId = user.uid;
                        console.log("Usuario autenticado:", userId);
                        resolve(user);
                    } else {
                        // FIX: Always sign in anonymously to avoid token mismatch with the execution environment.
                        signInAnonymously(auth).then(resolve).catch(reject);
                    }
                }, reject);
            });
        } catch (e) {
            console.error("Falla detallada de autenticaci√≥n:", { 
                message: e.message, 
                code: e.code, 
                stack: e.stack 
            });
            throw e;
        }
    }


    function runApp(isConnected = false) {
        const slides = document.querySelectorAll('main > section.slide');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const coverNextBtn = document.getElementById('cover-next-btn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const progressDotsContainer = document.getElementById('progress-dots');
        
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const passwordCancel = document.getElementById('password-cancel');
        const passwordSubmit = document.getElementById('password-submit');

        let currentSlideIndex = 0;
        let currentChart = null;
        let collectiveResultsChart = null;

        const courseContent = {
            teamMood: `
                <div class="content-card p-6 md:p-8 w-full">
                    <h3 class="font-orbitron text-2xl font-bold text-sky-400 text-center">Sesi√≥n 1: Team Mood - ¬øC√≥mo te sientes hoy?</h3>
                    <div class="flex flex-col lg:flex-row items-center gap-8 mt-6">
                        <div class="w-full lg:w-1/3 space-y-4">
                            <p class="text-gray-400 text-justify">Elige una figura del √°rbol, dibuja una carita con tu estado de √°nimo y escribe tu nombre debajo.</p>
                            <div>
                                <label for="participant-name" class="block text-sm font-medium text-gray-300 mb-2">1. Escribe tu nombre:</label>
                                <input type="text" id="participant-name" placeholder="Tu nombre aqu√≠..." class="w-full">
                            </div>
                            <div>
                                <p class="block text-sm font-medium text-gray-300 mb-2">2. Elige tu estado de √°nimo:</p>
                                <div id="mood-palette" class="grid grid-cols-3 gap-2"></div>
                            </div>
                            <p class="text-gray-400 text-sm">3. Haz clic en un c√≠rculo vac√≠o en el √°rbol para colocar tu estado de √°nimo.</p>
                             <button id="reset-mood-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Resetear Actividad</button>
                        </div>
                        <div id="mood-tree-container" class="w-full lg:w-2/3 h-96 relative">
                             <svg viewBox="0 0 800 600" class="w-full h-auto absolute top-0 left-0">
                                 <path d="M400 600 Q 380 400 250 300 Q 150 200 200 100" stroke="#785549" stroke-width="20" fill="none" />
                                 <path d="M400 600 Q 420 400 550 300 Q 650 200 600 100" stroke="#785549" stroke-width="20" fill="none" />
                                 <path d="M400 500 Q 400 350 400 200" stroke="#785549" stroke-width="15" fill="none" />
                                 <path d="M250 300 Q 300 250 350 150" stroke="#785549" stroke-width="15" fill="none" />
                                 <path d="M550 300 Q 500 250 450 150" stroke="#785549" stroke-width="15" fill="none" />
                             </svg>
                            <div id="tree-placeholders" class="w-full h-full absolute top-0 left-0"></div>
                        </div>
                    </div>
                </div>`,
            mindset: `
                <h3 class="font-orbitron text-2xl font-bold text-sky-400">Sesi√≥n 2: Mindset: El ADN del Innovador</h3>
                <div class="mt-4 text-gray-400 leading-relaxed space-y-3 text-justify">
                    <p>¬øSab√≠as que todo lo que logramos en la vida depende de qu√© tan convencidos estamos de que lo vamos a lograr?</p>
                    <p>Cambiar la mentalidad puede influir notoriamente en el resultado de las situaciones a las cuales nos enfrentamos. Sabemos que las cosas no siempre resultar√°n favorables al principio, pero lo importante es aprender y sobre todo plantearnos qu√© haremos despu√©s de fallar.</p>
                </div>
                 <div class="mt-8">
                     <h4 class="font-orbitron text-lg font-bold text-purple-400 mb-4">Tipos de Mentalidad seg√∫n Carol Dweck</h4>
                     <div class="space-y-2" id="mindset-types-accordion"></div>
                 </div>
                <div class="mt-8">
                    <h4 class="font-orbitron text-lg font-bold text-purple-400 mb-4">Pensamientos que Determinan Nuestro Comportamiento</h4>
                    <div class="space-y-2" id="mindset-behaviors-accordion"></div>
                </div>`,
            ideacion: `
                <h3 class="font-orbitron text-2xl font-bold text-sky-400">Sesi√≥n 3: Ideaci√≥n</h3>
                 <div class="mt-8 flex flex-col md:flex-row gap-8 items-center">
                     <div class="w-full md:w-1/2">
                         <h4 class="font-orbitron text-lg font-bold text-purple-400 mb-3">üß† Pensamiento Convergente y Divergente</h4>
                         <div class="space-y-4">
                             <div class="p-4 border border-gray-700 rounded-lg bg-gray-800/50">
                                 <h5 class="font-bold text-gray-200">Pensamiento Divergente</h5>
                                 <p class="text-gray-400 mt-1 leading-relaxed text-justify">La fase de exploraci√≥n mental en la que se generan m√∫ltiples ideas y posibilidades sin censura.</p>
                             </div>
                             <div class="p-4 border border-gray-700 rounded-lg bg-gray-800/50">
                                 <h5 class="font-bold text-gray-200">Pensamiento Convergente</h5>
                                 <p class="text-gray-400 mt-1 leading-relaxed text-justify">La fase anal√≠tica que implica organizar, evaluar y seleccionar las ideas m√°s prometedoras.</p>
                             </div>
                         </div>
                     </div>
                     <div class="w-full md:w-1/2">
                         <img src="https://i.imgur.com/Tjp67Wq.png" alt="Diagrama de Ideaci√≥n" class="rounded-lg shadow-lg w-full h-auto">
                     </div>
                 </div>`,
            pensamientoAssessment: `
                 <div id="quiz-container" class="w-full max-w-3xl mx-auto">
                     <div class="quiz-card p-6 md:p-8">
                         <div id="start-screen" class="assessment-screen text-center">
                             <h4 class="font-orbitron text-2xl font-bold text-purple-400 mb-3">El Prisma del Pensamiento</h4>
                             <p class="text-gray-400 italic my-4">"Las personas que est√°n lo suficientemente locas como para pensar que pueden cambiar el mundo, son las que lo hacen."</p>
                             <p class="text-gray-400 mb-6 leading-relaxed text-justify">Este ejercicio est√° dise√±ado para revelar tu estilo de pensamiento a trav√©s de una serie de desaf√≠os. ¬øCreas un universo de ideas o encuentras la √∫nica soluci√≥n brillante? Desc√∫brelo.</p>
                             <button id="start-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full text-lg">Comenzar el Viaje</button>
                         </div>
                         <div id="question-screen" class="assessment-screen">
                             <div class="flex justify-between items-center mb-4">
                                 <div id="progress-text" class="text-sm font-semibold text-gray-400"></div>
                                 <div id="timer" class="font-orbitron text-2xl text-sky-400 ml-4 w-24 text-right"></div>
                             </div>
                             <div class="w-full bg-gray-700 rounded-full h-2.5 mb-6"><div id="progress-bar" class="bg-sky-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                             <h2 id="question-title" class="text-xl font-semibold text-gray-200 mb-2"></h2>
                             <p id="question-text" class="text-gray-400 mb-6 leading-relaxed"></p>
                             <div id="answer-area"></div>
                             <div class="mt-8 flex justify-end">
                                 <button id="next-q-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">Siguiente</button>
                             </div>
                         </div>
                         <div id="result-screen" class="assessment-screen text-center">
                             <h2 class="text-3xl font-bold mb-4 font-orbitron gradient-text">Tu Perfil de Pensamiento</h2>
                             <div id="result-viz" class="w-full h-20 my-8 flex items-center justify-center space-x-2">
                                 <div class="text-right w-24"><div class="font-bold">Divergente</div><div class="text-sm text-gray-400">El Innovador</div></div>
                                 <div class="w-full h-4 bg-gray-700 rounded-full overflow-hidden relative">
                                     <div id="result-bar" class="absolute top-0 h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full transition-all duration-500" style="left: 50%; width: 0%;"></div>
                                     <div class="absolute top-0 left-1/2 w-px h-full bg-gray-500"></div>
                                 </div>
                                 <div class="text-left w-24"><div class="font-bold">Convergente</div><div class="text-sm text-gray-400">El Solucionador</div></div>
                             </div>
                             <h3 id="result-title" class="text-2xl font-semibold mb-2 text-sky-400"></h3>
                             <p id="result-description" class="text-gray-300 mb-8 max-w-md mx-auto"></p>
                               <div class="flex justify-center gap-4">
                                 <button id="restart-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full text-lg">Intentar de Nuevo</button>
                                 <button id="show-group-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full text-lg">Ver Perfil del Grupo</button>
                             </div>
                         </div>
                         <div id="group-result-screen" class="assessment-screen text-center">
                             <h2 class="text-3xl font-bold mb-4 font-orbitron gradient-text">Perfil de Pensamiento del Grupo</h2>
                                <p class="mb-4 text-gray-400">Total de Participantes: <span id="group-total-participants">0</span></p>
                                <div id="group-profile-pie-chart-container" class="relative mx-auto" style="height:300px; max-width:400px;">
                                    <canvas id="group-profile-pie-chart"></canvas>
                                </div>
                                <div id="group-result-description" class="text-gray-300 my-8 max-w-md mx-auto"></div>
                             <button id="back-to-individual-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-full text-lg">Volver a Mi Perfil</button>
                         </div>
                    </div>
                 </div>`,
            assessment: `
                <div class="diagnostico-card p-6 md:p-8">
                    <div id="assessment-intro">
                         <h3 class="text-2xl md:text-3xl font-bold text-gray-100 flex items-center justify-center mb-4 font-orbitron"><i class="fas fa-chart-line mr-3 text-sky-400"></i> Sesi√≥n 4: Assessment de Cambio</h3><p class="mt-2 text-base md:text-lg text-gray-400 text-justify max-w-3xl mx-auto">Responde para visualizar la brecha entre tu estado actual y tus aspiraciones.</p>
                         <div class="mt-8 mb-6 flex flex-wrap justify-center gap-4"><button id="scenarioPersonalBtn" class="tab-button active">Viaje Personal</button><button id="scenarioOrgBtn" class="tab-button inactive">Viaje del Proceso</button></div>
                         <div class="text-center"><button id="start-assessment-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-lg">Comenzar el Viaje</button></div>
                    </div>
                    <div id="assessment-quiz" class="hidden w-full">
                        <div id="assessment-progress-container" class="w-full bg-gray-700 rounded-full h-2.5 mb-4"><div id="assessment-progress-bar" class="bg-sky-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                        <div id="assessment-question-container" class="min-h-[200px]"></div>
                        <div class="mt-8 flex justify-between items-center w-full">
                            <button id="assessment-prev-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Anterior</button>
                            <button id="assessment-next-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg">Siguiente</button>
                        </div>
                    </div>
                     <div id="assessment-results" class="hidden w-full text-center">
                         <h4 class="text-2xl font-bold text-gray-100 mb-4">Resultados de tu Viaje</h4>
                         <div id="diagnosticoChartContainer" class="relative w-full h-72 mt-8"><canvas id="growthGapChart"></canvas></div>
                         <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4 w-full">
                             <button id="restart-assessment-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Repetir Viaje</button>
                             <button id="show-collective-assessment-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full">Ver Resultados de Grupo</button>
                             <button id="reset-assessment-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Resetear Selecci√≥n</button>
                         </div>
                    </div>
                    <div id="assessment-collective-results" class="hidden w-full text-center">
                         <h4 class="text-2xl font-bold text-gray-200 mb-4">Resultados del Grupo</h4>
                         <p class="mb-4">Total de Participantes: <span id="assessment-total-participants">0</span></p>
                         <div class="chart-container mx-auto" style="height: 300px;"><canvas id="collective-assessment-chart"></canvas></div>
                         <div class="flex justify-center flex-wrap gap-4 mt-8">
                             <button id="back-to-individual-assessment-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full">Volver a Mi Resultado</button>
                             <button id="reset-collective-assessment-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full">Resetear Resultados</button>
                         </div>
                    </div>
                </div>`,
            taller: `
                <div class="taller-card p-6 md:p-8">
                    <h3 class="text-2xl md:text-3xl font-bold text-gray-100 flex items-center justify-center mb-4 font-orbitron"><i class="fas fa-dice mr-3 text-purple-400"></i> Sesi√≥n 5: Taller - Ruta del Cambio con Dados</h3>
                    <p class="mt-2 text-base md:text-lg text-gray-400 text-justify max-w-4xl mx-auto">Lanza los dados para explorar tu perspectiva personal frente al cambio. Cada resultado te ayudar√° a construir una frase que resuma tu ruta √∫nica.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                        <div id="d6-container" class="bg-gray-900/50 p-4 rounded-lg"></div>
                        <div id="d8-container" class="bg-gray-900/50 p-4 rounded-lg"></div>
                        <div id="d10-container" class="bg-gray-900/50 p-4 rounded-lg"></div>
                        <div id="d20-container" class="bg-gray-900/50 p-4 rounded-lg"></div>
                    </div>
                    <div class="mt-8 bg-gray-900/50 p-6 rounded-lg text-center">
                         <h4 class="font-orbitron text-lg font-bold text-purple-400 mb-3">Mi Ruta del Cambio</h4>
                         <p id="ruta-resumen" class="text-xl text-gray-300 italic h-24 flex items-center justify-center">Lanza los dados para completar tu ruta...</p>
                    </div>
                    <div class="mt-8 bg-gray-900/50 p-6 rounded-lg">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-100 flex items-center justify-center mb-4 font-orbitron"><i class="fas fa-users mr-3 text-purple-400"></i>Patrones y Compromisos Colectivos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="team-name" class="block text-sm font-medium text-gray-300 mb-2">Nombre del equipo:</label><input type="text" id="team-name" class="w-full"></div>
                            <div><label for="team-participants" class="block text-sm font-medium text-gray-300 mb-2">Participantes:</label><input type="text" id="team-participants" class="w-full"></div>
                        </div>
                        <div class="mt-6"><label for="shared-routes" class="block text-sm font-medium text-gray-300 mb-2">1. Rutas compartidas (s√≠ntesis del grupo):</label><textarea id="shared-routes" rows="3" class="w-full"></textarea></div>
                        <div class="mt-6"><h4 class="text-md font-bold text-gray-200 mb-2">2. Patrones comunes que encontramos:</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label for="common-emotions" class="block text-xs font-medium text-gray-400 mb-1">Emociones repetidas:</label><textarea id="common-emotions" rows="2" class="w-full text-sm"></textarea></div><div><label for="key-actions" class="block text-xs font-medium text-gray-400 mb-1">Acciones clave:</label><textarea id="key-actions" rows="2" class="w-full text-sm"></textarea></div><div><label for="frequent-challenges" class="block text-xs font-medium text-gray-400 mb-1">Retos frecuentes:</label><textarea id="frequent-challenges" rows="2" class="w-full text-sm"></textarea></div></div></div>
                        <div class="mt-6"><h4 class="text-md font-bold text-gray-200 mb-2">3. Nuestros 3 compromisos colectivos de cambio:</h4><div class="space-y-3"><div><label for="commitment-1" class="block text-sm font-medium text-gray-400 mb-1">1.</label><input type="text" id="commitment-1" class="w-full"></div><div><label for="commitment-2" class="block text-sm font-medium text-gray-400 mb-1">2.</label><input type="text" id="commitment-2" class="w-full"></div><div><label for="commitment-3" class="block text-sm font-medium text-gray-400 mb-1">3.</label><input type="text" id="commitment-3" class="w-full"></div></div></div>
                    </div>
                     <div class="mt-8 text-center">
                         <button id="exportTallerPdfBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center mx-auto">
                             <i class="fas fa-file-pdf mr-2"></i>Exportar Taller a PDF
                         </button>
                     </div>
                </div>`,
            final: `
                <div class="animate-fade-in" style="animation: fadeIn 1s ease-out forwards;">
                    <h2 class="font-orbitron text-4xl md:text-5xl font-bold gradient-text mb-8">Gracias por emprender el viaje.</h2>
                    <p class="text-xl md:text-2xl text-gray-300 italic max-w-3xl mx-auto">"La innovaci√≥n es lo que distingue a un l√≠der de un seguidor."</p>
                    <p class="font-bold text-gray-400 mt-4">- Steve Jobs</p>
                    <p class="text-xl md:text-2xl text-gray-200 mt-12 max-w-2xl mx-auto">El cambio ha comenzado. Ahora, la pregunta no es qu√© sigue, sino qu√© vas a construir t√∫.</p>
                </div>`
        };

        const mindsetTypesAccordionItems = [
            { title: "Mentalidad Fija (Fixed Mindset)", content: "Ve las habilidades como algo innato e inmutable. Las personas con esta mentalidad tienden a evitar los desaf√≠os por miedo a revelar sus debilidades, creyendo que el talento por s√≠ solo es suficiente." },
            { title: "Mentalidad de Crecimiento (Growth Mindset)", content: "Percibe las habilidades como algo que se puede desarrollar y mejorar con esfuerzo y dedicaci√≥n. Quienes la poseen ven los fracasos como oportunidades de aprendizaje y buscan activamente los desaf√≠os para crecer." }
        ];

        const mindsetBehaviorsAccordionItems = [
            { title: "Paradigmas", content: "Son aquellos modelos mentales que nos han inculcado desde peque√±os y que determinan nuestra manera de actuar. Son el 'mapa' con el que interpretamos la realidad." },
            { title: "H√°bitos", content: "Son aquellas acciones cotidianas que repetimos de forma autom√°tica, es decir de forma inconsciente. Pueden ser constructivos o limitantes." },
            { title: "Creencias", content: "Son actitudes mentales que consisten en la aceptaci√≥n de una experiencia o una idea consider√°ndolas como verdaderas. Son las 'reglas' que damos por sentadas sobre c√≥mo funciona el mundo y nuestro lugar en √©l." }
        ];

        function showSlide(index) {
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
            });
            currentSlideIndex = index;
            updateNavButtons();
            updateProgressDots(index);
            
            if (currentChart) { currentChart.destroy(); currentChart = null; }
            if (collectiveResultsChart) { collectiveResultsChart.destroy(); collectiveResultsChart = null; }
            
            const activeSlideId = slides[index]?.id;
            if(!activeSlideId) return;

            const contentIsLoaded = document.getElementById(`${activeSlideId}-content`)?.hasChildNodes();
            
            if (!contentIsLoaded) {
                 if (activeSlideId === 'team-mood') loadTeamMood();
                 if (activeSlideId === 'mindset') loadMindset();
                 if (activeSlideId === 'ideacion') loadIdeacion();
                 if (activeSlideId === 'pensamiento-assessment') loadPensamientoAssessment();
                 if (activeSlideId === 'assessment') loadAssessment();
                 if (activeSlideId === 'taller') loadTaller();
                 if (activeSlideId === 'final') loadFinal();
            }
        }

        function updateNavButtons() {
            if (currentSlideIndex === 0) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                coverNextBtn.classList.remove('hidden');
            } else {
                coverNextBtn.classList.add('hidden');
                prevBtn.classList.remove('hidden');
                nextBtn.classList.toggle('hidden', currentSlideIndex === slides.length - 1);
            }
        }

        slides.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.classList.add('progress-dot');
            dot.dataset.index = i;
            dot.addEventListener('click', () => showSlide(i));
            progressDotsContainer.appendChild(dot);
        });
        const progressDots = progressDotsContainer.querySelectorAll('.progress-dot');

        function updateProgressDots(index) {
            progressDots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        function setupAccordion(containerId, items) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = items.map(item => `
                <div>
                    <button class="accordion-button w-full flex justify-between items-center text-left p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition-colors">
                        <h5 class="font-bold text-gray-200">${item.title}</h5>
                        <span class="icon text-sky-400">‚ñº</span>
                    </button>
                    <div class="accordion-content bg-gray-900/50 rounded-b-lg"><p class="text-gray-400 p-4 leading-relaxed text-justify">${item.content}</p></div>
                </div>`).join('');
            
            container.querySelectorAll('.accordion-button').forEach(button => {
                button.addEventListener('click', () => {
                    button.classList.toggle('active');
                    const content = button.nextElementSibling;
                    content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
                });
            });
        }

        function loadTeamMood() {
            document.getElementById('team-mood-content').innerHTML = courseContent.teamMood;
            setupTeamMood(isConnected);
        }

        function setupTeamMood(isConnected = false) {
            const nameInput = document.getElementById('participant-name');
            const moodPalette = document.getElementById('mood-palette');
            const placeholdersContainer = document.getElementById('tree-placeholders');
            const resetBtn = document.getElementById('reset-mood-btn');
            let selectedMood = null;

            if (!isConnected) {
                nameInput.disabled = true;
                resetBtn.disabled = true;
                resetBtn.style.opacity = '0.5';
                moodPalette.style.opacity = '0.5';
                moodPalette.style.pointerEvents = 'none';
                placeholdersContainer.parentElement.style.opacity = '0.5';
                placeholdersContainer.parentElement.style.pointerEvents = 'none';
                const warning = document.createElement('p');
                warning.className = 'text-center text-yellow-400 text-sm mt-4';
                warning.textContent = 'Funci√≥n interactiva deshabilitada por falta de conexi√≥n.';
                resetBtn.parentElement.appendChild(warning);
            }

            const moods = {
                feliz: { icon: 'fa-smile', color: 'text-yellow-400' },
                neutro: { icon: 'fa-meh', color: 'text-gray-400' },
                triste: { icon: 'fa-frown', color: 'text-blue-400' },
                enojado: { icon: 'fa-angry', color: 'text-red-500' },
                entusiasmado: { icon: 'fa-star', color: 'text-yellow-300' },
                confundido: { icon: 'fa-question-circle', color: 'text-orange-400' }
            };

            moodPalette.innerHTML = Object.entries(moods).map(([key, value]) => `
                <div class="mood-selector p-2 bg-gray-900/50 rounded-lg text-center" data-mood="${key}">
                    <i class="fas ${value.icon} ${value.color} text-3xl"></i>
                    <p class="text-xs mt-1 capitalize">${key}</p>
                </div>
            `).join('');

            moodPalette.querySelectorAll('.mood-selector').forEach(selector => {
                selector.addEventListener('click', () => {
                    moodPalette.querySelectorAll('.mood-selector').forEach(s => s.classList.remove('selected'));
                    selector.classList.add('selected');
                    selectedMood = selector.dataset.mood;
                });
            });
            
            const placeholderPositions = [
                { top: '15%', left: '20%' }, { top: '5%', left: '35%' }, { top: '10%', left: '50%' }, { top: '5%', left: '65%' }, { top: '15%', left: '80%' },
                { top: '35%', left: '15%' }, { top: '30%', left: '30%' }, { top: '30%', left: '50%' }, { top: '30%', left: '70%' }, { top: '35%', left: '85%' },
                { top: '55%', left: '25%' }, { top: '50%', left: '45%' }, { top: '50%', left: '65%' }, { top: '55%', left: '75%' },
                { top: '75%', left: '35%' }, { top: '75%', left: '55%' },
                { top: '25%', left: '5%' }, { top: '25%', left: '90%' }, { top: '65%', left: '10%' }, { top: '65%', left: '85%' }
            ];

            placeholdersContainer.innerHTML = placeholderPositions.map((pos, i) => `
                <div class="tree-placeholder w-20 h-20" style="left: ${pos.left}; top: ${pos.top};" data-index="${i}"></div>
            `).join('');

            if (isConnected && db) {
                const collectionPath = `/artifacts/${appId}/public/data/team-mood`;

                onSnapshot(collection(db, collectionPath), (snapshot) => {
                    placeholdersContainer.querySelectorAll('.tree-placeholder').forEach(p => {
                        p.innerHTML = `<div class="w-16 h-16 rounded-full bg-gray-800/50 border-2 border-dashed border-gray-600"></div>`;
                    });
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const placeholder = placeholdersContainer.querySelector(`.tree-placeholder[data-index="${data.index}"]`);
                        if (placeholder && moods[data.mood]) {
                            const mood = moods[data.mood];
                            placeholder.innerHTML = `
                                <div class="w-16 h-16 rounded-full flex flex-col items-center justify-center bg-gray-900/80 border-2 border-sky-500">
                                    <i class="fas ${mood.icon} ${mood.color} text-3xl"></i>
                                    <p class="text-xs mt-1 font-bold truncate w-14 text-center">${data.name}</p>
                                </div>
                            `;
                        }
                    });
                });

                placeholdersContainer.querySelectorAll('.tree-placeholder').forEach(p => {
                    p.addEventListener('click', () => {
                        if (!selectedMood || !nameInput.value.trim()) {
                            console.warn("Nombre y estado de √°nimo son requeridos.");
                            return;
                        }
                        const data = { name: nameInput.value.trim(), mood: selectedMood, index: p.dataset.index, userId: userId };
                        setDoc(doc(db, collectionPath, userId), data);
                    });
                });

                async function resetTeamMood() {
                    const querySnapshot = await getDocs(collection(db, collectionPath));
                    const deletePromises = [];
                    querySnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                    await Promise.all(deletePromises);
                    console.log("La actividad ha sido reseteada.");
                }
                resetBtn.onclick = () => promptPassword(resetTeamMood);
            }
        }
        
        function loadMindset() {
            document.getElementById('mindset-content').innerHTML = courseContent.mindset;
            setupAccordion('mindset-types-accordion', mindsetTypesAccordionItems);
            setupAccordion('mindset-behaviors-accordion', mindsetBehaviorsAccordionItems);
        }

        function loadIdeacion() {
            document.getElementById('ideacion-content').innerHTML = courseContent.ideacion;
        }

        function loadPensamientoAssessment() {
            document.getElementById('pensamiento-assessment-content').innerHTML = courseContent.pensamientoAssessment;
            setupPensamientoAssessment(isConnected);
        }
        
        function setupPensamientoAssessment(isConnected = false) {
            const container = document.getElementById('quiz-container');
            if (!container) return;

            const screens = {
                start: container.querySelector('#start-screen'),
                question: container.querySelector('#question-screen'),
                result: container.querySelector('#result-screen'),
                groupResult: container.querySelector('#group-result-screen')
            };
            const elements = {
                startBtn: container.querySelector('#start-btn'),
                restartBtn: container.querySelector('#restart-btn'),
                nextBtn: container.querySelector('#next-q-btn'),
                showGroupBtn: container.querySelector('#show-group-btn'),
                backToIndividualBtn: container.querySelector('#back-to-individual-btn'),
                progressText: container.querySelector('#progress-text'),
                progressBar: container.querySelector('#progress-bar'),
                timer: container.querySelector('#timer'),
                qTitle: container.querySelector('#question-title'),
                qText: container.querySelector('#question-text'),
                answerArea: container.querySelector('#answer-area'),
                resultViz: container.querySelector('#result-viz'),
                resultBar: container.querySelector('#result-bar'),
                resultTitle: container.querySelector('#result-title'),
                resultDescription: container.querySelector('#result-description'),
                groupTotalParticipants: container.querySelector('#group-total-participants'),
                groupResultDescription: container.querySelector('#group-result-description')
            };

            let scores = { divergent: 0, convergent: 0 };
            let currentQIndex = 0;
            let timerInterval;
            let questions = [];
            let groupPieChartInstance = null;

            const questionBank = {
                convergent: [
                    { title: "Acertijo L√≥gico", text: "Tengo ciudades, pero no casas. Tengo monta√±as, pero no √°rboles. Tengo agua, pero no peces. ¬øQu√© soy?", answer: "mapa", time: 45 },
                    { title: "Acertijo Cl√°sico", text: "Alim√©ntame y vivir√©, pero dame de beber y morir√©. ¬øQu√© soy?", answer: "fuego", time: 45 },
                    { title: "Secuencia Num√©rica", text: "¬øQu√© n√∫mero sigue en esta secuencia: 1, 4, 9, 16, ...?", answer: "25", time: 30 },
                    { title: "Secuencia Num√©rica", text: "¬øQu√© n√∫mero sigue en esta secuencia de n√∫meros primos: 2, 3, 5, 7, 11, ...?", answer: "13", time: 30 },
                    { title: "L√≥gica Inversa", text: "Un granjero tiene 17 ovejas y todas menos 9 mueren. ¬øCu√°ntas le quedan?", answer: "9", time: 45 },
                    { title: "Secuencia de Letras", text: "¬øQu√© letra sigue en esta secuencia: E, F, M, A, M, ...? (Pista: meses del a√±o)", answer: "j", time: 30 },
                    { title: "Acertijo de Supervivencia", text: "Si un avi√≥n se estrella en la frontera entre Colombia y Ecuador, ¬ød√≥nde entierran a los supervivientes?", answer: "no se entierran", time: 45 },
                ],
                divergent: [
                    { title: "Usos Inusuales", text: "Tienes 60 segundos. Escribe la mayor cantidad de usos posibles para un clip. Separa cada idea con un salto de l√≠nea (Enter).", type: "list", time: 60 },
                    { title: "Usos Inusuales", text: "Tienes 60 segundos. Escribe todos los usos posibles para una botella de pl√°stico vac√≠a. Separa cada idea con un salto de l√≠nea (Enter).", type: "list", time: 60 },
                    { title: "Escenario Hipot√©tico", text: "A partir de este momento, todos los seres humanos pueden volar hasta dos metros de altura. ¬øQu√© tres cosas cambiar√≠an radicalmente en nuestra sociedad? S√© creativo.", type: "text", time: 60 },
                    { title: "Escenario Hipot√©tico", text: "Imagina que el color azul desaparece del mundo. Describe tres consecuencias inesperadas.", type: "text", time: 60 },
                    { title: "Dise√±o Creativo", text: "Dise√±a un nuevo deporte que se juegue en gravedad cero. Describe sus reglas b√°sicas en pocas l√≠neas.", type: "text", time: 60 },
                    { title: "Pregunta Abierta", text: "Si los animales pudieran hablar, ¬øqu√© pregunta le har√≠as a un delf√≠n y por qu√©?", type: "text", time: 60 },
                ]
            };
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function generateQuiz() {
                shuffleArray(questionBank.convergent);
                shuffleArray(questionBank.divergent);
                
                const selectedConvergent = questionBank.convergent.slice(0, 2).map(q => ({...q, questionType: 'convergent'}));
                const selectedDivergent = questionBank.divergent.slice(0, 3).map(q => ({...q, questionType: 'divergent'}));;
                
                questions = [...selectedConvergent, ...selectedDivergent];
                shuffleArray(questions);
            }

            function showScreen(screenName) {
                Object.values(screens).forEach(s => s.style.display = 'none');
                screens[screenName].style.display = 'block';
            }

            function startTimer(duration, onComplete) {
                let timeLeft = duration;
                clearInterval(timerInterval);
                elements.timer.textContent = `${timeLeft}s`;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    elements.timer.textContent = `${timeLeft}s`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        onComplete();
                    }
                }, 1000);
            }
            
            function loadQuestion() {
                if (currentQIndex >= questions.length) {
                    showResults();
                    return;
                }

                const q = questions[currentQIndex];
                elements.progressText.textContent = `Pregunta ${currentQIndex + 1} de ${questions.length}`;
                elements.progressBar.style.width = `${((currentQIndex) / questions.length) * 100}%`;
                elements.qTitle.textContent = q.title;
                elements.qText.textContent = q.text;
                elements.answerArea.innerHTML = '';

                if (q.questionType === 'convergent') {
                    elements.answerArea.innerHTML = `<input type="text" id="answer-input" class="w-full" placeholder="Escribe tu respuesta...">`;
                } else {
                    elements.answerArea.innerHTML = `<textarea id="answer-input" rows="5" class="w-full" placeholder="Desarrolla tus ideas aqu√≠..."></textarea>`;
                }

                document.getElementById('answer-input').focus();
                
                const timeLimit = q.time || 45;
                startTimer(timeLimit, () => elements.nextBtn.click());
            }

            function processAnswer() {
                const q = questions[currentQIndex];
                const input = document.getElementById('answer-input');
                if (!input) return;
                const value = input.value.trim();

                if (q.questionType === 'convergent') {
                    if (value.toLowerCase() === q.answer) {
                        scores.convergent += 25;
                    }
                } else if (q.type === 'list') {
                    const ideas = value.split('\n').filter(idea => idea.trim() !== '');
                    scores.divergent += Math.min(25, ideas.length * 2);
                } else if (q.type === 'text') {
                    if (value.length > 50) {
                        scores.divergent += 25;
                    }
                }
            }
            
            function handleNext() {
                processAnswer();
                currentQIndex++;
                loadQuestion();
            }

            async function showResults() {
                clearInterval(timerInterval);
                showScreen('result');
                elements.progressBar.style.width = '100%';

                if (db && userId && isConnected) {
                    const collectionPath = `/artifacts/${appId}/public/data/pensamiento-assessment`;
                    try {
                        await setDoc(doc(db, collectionPath, userId), {
                            userId,
                            scores,
                            timestamp: new Date()
                        });
                        console.log("Resultados de pensamiento guardados.");
                    } catch (error) {
                        console.error("Error guardando resultados de pensamiento:", error);
                    }
                }

                const totalScore = scores.convergent + scores.divergent;
                if (totalScore === 0) {
                    elements.resultTitle.textContent = "El Lienzo en Blanco";
                    elements.resultDescription.textContent = "Para descubrir tu perfil de pensamiento, necesitamos tu perspectiva. Vuelve a intentarlo y comparte tus ideas. Cada gran viaje comienza con un solo paso.";
                    elements.resultViz.style.display = 'none';
                    return;
                }

                elements.resultViz.style.display = 'flex';
                const divergentWeight = (scores.divergent / totalScore) * 100;
                
                const { title, description } = getProfileText(divergentWeight);
                elements.resultTitle.textContent = title;
                elements.resultDescription.textContent = description;
                
                updateProfileBar(elements.resultBar, divergentWeight);
            }
            
            function getProfileText(divergentWeight) {
                if (divergentWeight > 65) {
                    return {
                        title: "El Innovador Disruptivo",
                        description: "Tu mente es un universo en expansi√≥n, lleno de posibilidades. No ves un objeto, ves un potencial infinito. Eres la chispa que inicia las revoluciones. Tu desaf√≠o es canalizar esa energ√≠a creativa hacia un punto focal."
                    };
                } else if (divergentWeight > 55) {
                     return {
                        title: "El Visionario Creativo",
                        description: "Te inclinas naturalmente hacia la generaci√≥n de ideas. Ves conexiones y posibilidades que otros pasan por alto, combinando una imaginaci√≥n f√©rtil con un sentido pr√°ctico. Eres excelente en las primeras etapas de un proyecto."
                    };
                } else if (divergentWeight > 45) {
                    return {
                        title: "El Arquitecto del Pensamiento",
                        description: "Posees un equilibrio excepcional. Puedes generar un torbellino de ideas y, al mismo tiempo, tienes la capacidad de enfocarte y encontrar soluciones precisas. Eres el puente entre la visi√≥n y la ejecuci√≥n."
                    };
                } else if (divergentWeight > 35) {
                    return {
                        title: "El Solucionador Estrat√©gico",
                        description: "Tu fortaleza radica en analizar situaciones complejas y encontrar el camino m√°s efectivo. Aunque tu pensamiento es principalmente l√≥gico, sabes cu√°ndo incorporar una idea creativa para optimizar el resultado."
                    };
                } else {
                    return {
                        title: "El Maestro de la L√≥gica",
                        description: "Ante el caos, encuentras el orden. Eres capaz de analizar la informaci√≥n, eliminar el ruido y llegar a la respuesta correcta. Tu pensamiento es preciso y poderoso. Tu oportunidad de crecimiento es buscar inspiraci√≥n en lo inesperado."
                    };
                }
            }

            function updateProfileBar(barElement, divergentWeight) {
                const balancePoint = 50;
                const maxPull = 45;

                let barStart, barWidth;
                if(divergentWeight > balancePoint) {
                    const pull = ((divergentWeight - balancePoint) / balancePoint) * maxPull;
                    barStart = balancePoint - pull;
                    barWidth = pull;
                    barElement.style.background = 'linear-gradient(to right, #a78bfa, #ec4899)';
                } else {
                    const pull = ((balancePoint - divergentWeight) / balancePoint) * maxPull;
                    barStart = balancePoint;
                    barWidth = pull;
                    barElement.style.background = 'linear-gradient(to right, #38bdf8, #22d3ee)';
                }
                barElement.style.left = `${barStart}%`;
                barElement.style.width = `${barWidth}%`;
            }
            
            function showGroupResults() {
                if (!isConnected) {
                    elements.groupResultDescription.innerHTML = `<h3 class="text-2xl font-semibold mb-2 text-sky-400">Funci√≥n no disponible</h3><p>La vista de grupo requiere una conexi√≥n activa.</p>`;
                    const chartContainer = document.getElementById('group-profile-pie-chart-container');
                    if (chartContainer) chartContainer.style.display = 'none';
                    showScreen('groupResult');
                    return;
                }

                if (!db) return;
                showScreen('groupResult');
                const collectionPath = `/artifacts/${appId}/public/data/pensamiento-assessment`;

                onSnapshot(collection(db, collectionPath), (snapshot) => {
                    const results = snapshot.docs.map(doc => doc.data().scores);
                    const participantCount = results.length;
                    elements.groupTotalParticipants.textContent = participantCount;
                    const chartContainer = document.getElementById('group-profile-pie-chart-container');

                    if (participantCount === 0) {
                        if (chartContainer) chartContainer.style.display = 'none';
                        elements.groupResultDescription.innerHTML = `<h3 class="text-2xl font-semibold mb-2 text-sky-400">A√∫n no hay datos</h3><p>S√© el primero en completar el assessment para empezar a formar el perfil del grupo.</p>`;
                        return;
                    }

                    if (chartContainer) chartContainer.style.display = 'block';
                    elements.groupResultDescription.innerHTML = ''; // Clear message

                    const profileCounts = {
                        "Innovador Disruptivo": 0,
                        "Visionario Creativo": 0,
                        "Arquitecto del Pensamiento": 0,
                        "Solucionador Estrat√©gico": 0,
                        "Maestro de la L√≥gica": 0,
                    };

                    results.forEach(scores => {
                        const totalScore = scores.convergent + scores.divergent;
                        if (totalScore > 0) {
                            const divergentWeight = (scores.divergent / totalScore) * 100;
                            if (divergentWeight > 65) profileCounts["Innovador Disruptivo"]++;
                            else if (divergentWeight > 55) profileCounts["Visionario Creativo"]++;
                            else if (divergentWeight > 45) profileCounts["Arquitecto del Pensamiento"]++;
                            else if (divergentWeight > 35) profileCounts["Solucionador Estrat√©gico"]++;
                            else profileCounts["Maestro de la L√≥gica"]++;
                        }
                    });

                    const chartLabels = Object.keys(profileCounts);
                    const chartData = Object.values(profileCounts);
                    
                    const ctx = document.getElementById('group-profile-pie-chart')?.getContext('2d');
                    if (!ctx) return;
                    
                    if (groupPieChartInstance) {
                        groupPieChartInstance.destroy();
                    }

                    groupPieChartInstance = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: chartLabels.filter((_, i) => chartData[i] > 0), // Only show profiles that exist
                            datasets: [{
                                label: 'Participantes',
                                data: chartData.filter(count => count > 0), // Only show data for existing profiles
                                backgroundColor: [
                                    '#ec4899', // Innovador
                                    '#a78bfa', // Visionario
                                    '#22d3ee', // Arquitecto
                                    '#38bdf8', // Solucionador
                                    '#60a5fa', // Maestro
                                ],
                                borderColor: '#1f2937', 
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#E5E7EB',
                                        font: { size: 12 },
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const total = context.chart.getDatasetMeta(0).total;
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                            return `${label}: ${value} (${percentage})`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
            }

            function resetQuiz() {
                scores = { divergent: 0, convergent: 0 };
                currentQIndex = 0;
                clearInterval(timerInterval);
                showScreen('start');
            }
            
            elements.startBtn.addEventListener('click', () => {
                generateQuiz();
                showScreen('question');
                loadQuestion();
            });
            elements.nextBtn.addEventListener('click', handleNext);
            elements.restartBtn.addEventListener('click', resetQuiz);
            elements.showGroupBtn.addEventListener('click', showGroupResults);
            elements.backToIndividualBtn.addEventListener('click', () => showScreen('result'));


            showScreen('start');
        }

        function loadAssessment() {
            document.getElementById('assessment-content').innerHTML = courseContent.assessment;
            setupAssessment(isConnected);
        }

        function setupAssessment(isConnected = false) {
            const introDiv = document.getElementById('assessment-intro');
            const quizDiv = document.getElementById('assessment-quiz');
            const resultsDiv = document.getElementById('assessment-results');
            const collectiveResultsDiv = document.getElementById('assessment-collective-results');
            const startBtn = document.getElementById('start-assessment-btn');
            const questionContainer = document.getElementById('assessment-question-container');
            const progressBar = document.getElementById('assessment-progress-bar');
            const prevBtn = document.getElementById('assessment-prev-btn');
            const nextBtn = document.getElementById('assessment-next-btn');
            const restartBtn = document.getElementById('restart-assessment-btn');
            const showCollectiveBtn = document.getElementById('show-collective-assessment-btn');
            const resetBtn = document.getElementById('reset-assessment-btn');
            const backToIndividualBtn = document.getElementById('back-to-individual-assessment-btn');
            const resetCollectiveBtn = document.getElementById('reset-collective-assessment-btn');
            const personalBtn = document.getElementById('scenarioPersonalBtn');
            const orgBtn = document.getElementById('scenarioOrgBtn');
            const totalParticipantsEl = document.getElementById('assessment-total-participants');

            let currentAssessmentQIndex = 0;
            let activeScenario = 'personal';
            let answers = {};
            
            const questions = {
                 personal: [
                     { id: 'pq1', label: 'Imagina que un nuevo portal m√°gico (plataforma tecnol√≥gica) aparece en tu trabajo. ¬øCu√°l es tu reacci√≥n?', options: { 'Me escondo debajo de la mesa': 10, 'Espero a que alguien m√°s lo pruebe': 25, 'Lo exploro con cautela': 50, '¬°Genial! A ver qu√© hace': 75, 'Lo domino antes del almuerzo': 90 } },
                     { id: 'pq2', label: 'El mapa del tesoro (proceso de trabajo) ha cambiado de ruta. ¬øQu√© haces?', options: { 'Me quejo, el mapa antiguo era mejor': 10, 'Me frustro un poco': 25, 'Suspiro y sigo la nueva ruta': 50, 'Busco las ventajas de la nueva ruta': 75, '¬°Me encanta! Un nuevo desaf√≠o': 90 } },
                     { id: 'pq3', label: 'Para tu pr√≥xima gran aventura, necesitas nuevas herramientas en tu mochila (habilidades). ¬øCon qu√© frecuencia las buscas?', options: { '¬øNuevas? Las m√≠as a√∫n funcionan': 20, 'Solo si el manual lo exige': 50, 'Busco algunas de vez en cuando': 80, 'Siempre estoy buscando lo √∫ltimo': 100 } },
                     { id: 'pq4', label: 'Un sabio viajero (cliente) te ofrece un consejo para mejorar tu camino. ¬øC√≥mo lo recibes?', options: { 'Prefiero mis propios consejos': 30, 'Lo escucho, pero dudo': 60, 'Agradezco y lo considero seriamente': 90, '¬°Excelente! Lo aplico de inmediato': 100 } },
                     { id: 'pq5', label: 'Hay un nuevo "mapa de la felicidad del cliente" (Estudio Cx). ¬øQu√© tan claro tienes c√≥mo usarlo en tu d√≠a a d√≠a?', options: { 'No s√© ni d√≥nde est√° el mapa': 10, 'Lo he visto, pero no lo entiendo': 30, 'Entiendo las partes importantes': 60, 'Lo uso como mi gu√≠a principal': 90 } },
                     { id: 'pq6', label: 'Durante el viaje, el equipo se encuentra con un obst√°culo. ¬øCon qu√© frecuencia propones un nuevo atajo o soluci√≥n?', options: { 'Espero a que el l√≠der decida': 10, 'Solo si me preguntan directamente': 30, 'A veces, si tengo una buena idea': 60, 'Casi siempre, me gusta proponer': 90 } }
                 ],
                 org: [
                     { id: 'oq1', label: 'Pensemos en nuestro barco (el proceso). En los √∫ltimos 3 a√±os, ¬øc√≥mo ha sido su velocidad y capacidad para cambiar de rumbo?', options: { 'Como un ancla en el lodo': 10, 'Lento, pero se mueve': 25, 'Tiene un ritmo decente': 50, 'Es bastante √°gil': 75, 'Como un barco de carreras': 90 } },
                     { id: 'oq2', label: 'Las herramientas de navegaci√≥n de nuestro barco (tecnolog√≠a actual), ¬ønos ayudan a ir m√°s r√°pido o nos retrasan?', options: { 'Nos hacen remar en c√≠rculos': 10, 'Son viejas y poco fiables': 25, 'Cumplen su funci√≥n, sin m√°s': 50, 'Son muy √∫tiles y eficientes': 75, 'Son de √∫ltima generaci√≥n': 90 } },
                     { id: 'oq3', label: 'Mirando al futuro (1-2 a√±os), ¬øqu√© tan grande es tu sue√±o para mejorar el barco?', options: { 'Con que flote, me conformo': 20, 'Unas velas nuevas estar√≠an bien': 50, 'Mejorar significativamente la velocidad': 80, '¬°Un motor de cohete para automatizarlo todo!': 100 } },
                     { id: 'oq4', label: 'La tripulaci√≥n (el equipo) necesita aprender a usar un nuevo tipo de vela (la nueva plataforma). ¬øCu√°l es su actitud?', options: { 'Se amotinar√≠an': 30, 'Hay mucho escepticismo': 60, 'Est√°n dispuestos, pero con nervios': 90, '¬°Listos para desplegar velas!': 100 } },
                     { id: 'oq5', label: 'El nuevo "mapa de la felicidad del cliente" (Estudio Cx) es crucial para el viaje. ¬øCon qu√© inter√©s lo has estudiado para tu puesto?', options: { 'No lo he mirado': 10, 'Lo conozco por encima': 30, 'He estudiado las partes relevantes': 60, 'Lo he memorizado y propongo mejoras': 90 } },
                     { id: 'oq6', label: 'Ante una tormenta inesperada (un problema), ¬øcon qu√© frecuencia el equipo usa una maniobra creativa en lugar de la de siempre?', options: { 'Siempre hacemos lo mismo': 10, 'Rara vez probamos algo nuevo': 30, 'A veces, si la situaci√≥n es grave': 60, 'Frecuentemente buscamos soluciones innovadoras': 90 } }
                 ]
            };
            
            personalBtn.onclick = () => { activeScenario = 'personal'; personalBtn.classList.replace('inactive', 'active'); orgBtn.classList.replace('active', 'inactive'); };
            orgBtn.onclick = () => { activeScenario = 'org'; orgBtn.classList.replace('inactive', 'active'); personalBtn.classList.replace('active', 'inactive'); };

            startBtn.onclick = () => {
                introDiv.classList.add('hidden');
                resultsDiv.classList.add('hidden');
                collectiveResultsDiv.classList.add('hidden');
                quizDiv.classList.remove('hidden');
                currentAssessmentQIndex = 0;
                answers[activeScenario] = new Array(questions[activeScenario].length).fill(0);
                showAssessmentQuestion();
            };
            
            function showAssessmentQuestion() {
                const q = questions[activeScenario][currentAssessmentQIndex];
                const optionsHtml = Object.entries(q.options).map(([text, value]) => `<option value="${value}">${text}</option>`).join('');
                questionContainer.innerHTML = `
                    <div class="text-center animate-fade-in" style="animation: fadeIn 0.3s ease-out forwards;">
                        <label for="${q.id}" class="block text-lg font-medium text-gray-300 mb-4 text-center">${q.label}</label>
                        <select id="${q.id}" class="block w-full max-w-md mx-auto">
                            <option value="0" disabled selected>Selecciona tu respuesta...</option>
                            ${optionsHtml}
                        </select>
                    </div>`;
                const select = questionContainer.querySelector('select');
                if (answers[activeScenario] && answers[activeScenario][currentAssessmentQIndex] > 0) {
                    select.value = answers[activeScenario][currentAssessmentQIndex];
                }
                select.onchange = () => {
                    answers[activeScenario][currentAssessmentQIndex] = parseInt(select.value);
                };
                
                progressBar.style.width = `${((currentAssessmentQIndex + 1) / questions[activeScenario].length) * 100}%`;
                prevBtn.style.visibility = currentAssessmentQIndex === 0 ? 'hidden' : 'visible';
                nextBtn.textContent = currentAssessmentQIndex === questions[activeScenario].length - 1 ? 'Ver Resultados' : 'Siguiente';
            }

            nextBtn.onclick = () => {
                 if (answers[activeScenario]?.[currentAssessmentQIndex] > 0) {
                    if (currentAssessmentQIndex < questions[activeScenario].length - 1) {
                        currentAssessmentQIndex++;
                        showAssessmentQuestion();
                    } else {
                        showAssessmentResults();
                    }
                } else {
                    console.warn("Por favor, selecciona una respuesta.");
                }
            };
            
            prevBtn.onclick = () => {
                if (currentAssessmentQIndex > 0) {
                    currentAssessmentQIndex--;
                    showAssessmentQuestion();
                }
            };
            
            async function showAssessmentResults() {
                quizDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');
                let total = 0, count = 0;
                answers[activeScenario].forEach(val => { if(val > 0) { total += val; count++; } });
                const avg = count > 0 ? total / count : 0;
                
                if (db && userId && isConnected) {
                    const collectionPath = `/artifacts/${appId}/public/data/assessment-cambio`;
                    await setDoc(doc(db, collectionPath, userId + '-' + activeScenario), { 
                        userId, 
                        score: avg, 
                        scenario: activeScenario, 
                        timestamp: new Date() 
                    });
                }
                
                const ctx = document.getElementById('growthGapChart')?.getContext('2d');
                if(!ctx) return;
                if (currentChart) currentChart.destroy();
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Tu Viaje Actual', 'Destino Deseado'],
                        datasets: [{ label: 'Rendimiento', data: [avg, 85], backgroundColor: ['#a78bfa', '#38bdf8'], borderRadius: 8 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            restartBtn.onclick = () => {
                resultsDiv.classList.add('hidden');
                collectiveResultsDiv.classList.add('hidden');
                introDiv.classList.remove('hidden');
            };

            function resetAssessmentSelections() {
                answers[activeScenario] = new Array(questions[activeScenario].length).fill(0);
                console.log("Tu selecci√≥n ha sido reiniciada.");
                introDiv.classList.remove('hidden');
                quizDiv.classList.add('hidden');
                resultsDiv.classList.add('hidden');
                collectiveResultsDiv.classList.add('hidden');
            }
            resetBtn.onclick = () => promptPassword(resetAssessmentSelections);
            
            showCollectiveBtn.onclick = () => {
                resultsDiv.classList.add('hidden');
                collectiveResultsDiv.classList.remove('hidden');
                showCollectiveAssessmentResults();
            };
            
            backToIndividualBtn.onclick = () => {
                collectiveResultsDiv.classList.add('hidden');
                resultsDiv.classList.remove('hidden');
            };
            
            async function resetCollectiveAssessmentResults() {
                 if (!db) { console.error("Error: No hay conexi√≥n con la base de datos."); return; }
                const collectionPath = `/artifacts/${appId}/public/data/assessment-cambio`;
                const querySnapshot = await getDocs(collection(db, collectionPath));
                const deletePromises = [];
                querySnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                await Promise.all(deletePromises);
                console.log("Los resultados colectivos han sido reseteados.");
                showCollectiveAssessmentResults();
            }
            
            resetCollectiveBtn.onclick = () => promptPassword(resetCollectiveAssessmentResults);

            function showCollectiveAssessmentResults() {
                 if (!isConnected) {
                    collectiveResultsDiv.innerHTML = `<h4 class="text-2xl font-bold text-gray-200 mb-4">Funci√≥n no disponible</h4><p class="text-gray-400">La vista de grupo requiere una conexi√≥n activa.</p><div class="mt-8"><button id="back-to-individual-assessment-btn-offline" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full">Volver a Mi Resultado</button></div>`;
                    document.getElementById('back-to-individual-assessment-btn-offline').onclick = backToIndividualBtn.onclick;
                    return;
                }

                if (!db) return;
                const collectionPath = `/artifacts/${appId}/public/data/assessment-cambio`;
                onSnapshot(collection(db, collectionPath), (snapshot) => {
                    const results = snapshot.docs.map(doc => doc.data()).filter(d => d.scenario === activeScenario);
                    totalParticipantsEl.textContent = results.length;
                    
                    const totalScore = results.reduce((sum, result) => sum + result.score, 0);
                    const groupAvg = results.length > 0 ? totalScore / results.length : 0;
                    
                    const ctx = document.getElementById('collective-assessment-chart')?.getContext('2d');
                    if (!ctx) return;
                    if (collectiveResultsChart) collectiveResultsChart.destroy();
                    collectiveResultsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Promedio del Grupo', 'Destino Deseado'],
                            datasets: [{ label: 'Rendimiento', data: [groupAvg, 85], backgroundColor: ['#a78bfa', '#38bdf8'], borderRadius: 8 }]
                        },
                         options: {
                             responsive: true, maintainAspectRatio: false,
                             scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } },
                             plugins: { legend: { display: false } }
                        }
                    });
                });
            }
        }
        
        function loadTaller() {
            document.getElementById('taller-content').innerHTML = courseContent.taller;
            setupTaller();
        }

        function setupTaller() {
            const diceData = {
                d6: {
                    title: 'D6 - √Ångulo de Cambio',
                    options: ['Cliente externo (afiliado/empresa)', 'Cliente interno (compa√±ero del √°rea)', 'Tu propio rol', 'La organizaci√≥n como sistema', 'La cultura digital', 'La confianza en el futuro']
                },
                d8: {
                    title: 'D8 - Emoci√≥n frente al cambio',
                    options: ['Entusiasmo', 'Miedo', 'Curiosidad', 'Resistencia', 'Esperanza', 'Confusi√≥n', 'Confianza', 'Energ√≠a renovada']
                },
                d10: {
                    title: 'D10 - Acci√≥n posible',
                    options: ['Escuchar activamente', 'Preguntar sin miedo', 'Probar una nueva herramienta', 'Apoyar a un compa√±ero', 'Proponer una mejora', 'Buscar capacitaci√≥n', 'Compartir buenas pr√°cticas', 'Innovar en lo peque√±o', 'Celebrar un logro', 'Reconocer un esfuerzo']
                },
                d20: {
                    title: 'D20 - Retos del camino',
                    options: ['Resistencia propia', 'Falta de tiempo', 'Desconocimiento tecnol√≥gico', 'Comunicaci√≥n incompleta', 'Procesos r√≠gidos', 'Temor al error', 'Distracciones', 'Doble carga de trabajo', 'Diferencias generacionales', 'Prioridades cambiantes', 'Expectativas poco claras', 'Escasa confianza', 'Falta de motivaci√≥n', 'Exceso de informaci√≥n', 'Dependencia de otros', 'Poca creatividad', 'Enfoque en el pasado', 'Aislamiento', 'Poco reconocimiento', 'Adaptaci√≥n lenta']
                }
            };

            let selections = { d6: null, d8: null, d10: null, d20: null };

            function updateRutaResumen() {
                const resumenEl = document.getElementById('ruta-resumen');
                const { d6, d8, d10, d20 } = selections;
                if (d6 && d8 && d10 && d20) {
                    resumenEl.innerHTML = `Desde la perspectiva de <b class="text-sky-400">${d6}</b>, siento <b class="text-sky-400">${d8}</b>. Puedo <b class="text-sky-400">${d10}</b>, pero debo superar el reto de <b class="text-sky-400">${d20}</b>.`;
                } else {
                     resumenEl.innerHTML = 'Lanza los dados para completar tu ruta...';
                }
            }

            Object.keys(diceData).forEach(key => {
                const container = document.getElementById(`${key}-container`);
                const data = diceData[key];
                let optionsHtml = data.options.map((opt, i) => `<div class="dice-option bg-gray-800 p-2 my-1 rounded text-xs cursor-pointer transition-all duration-300 hover:bg-gray-700">${i + 1}. ${opt}</div>`).join('');
                
                container.innerHTML = `
                    <h5 class="font-orbitron text-md font-bold text-purple-400 mb-2">${data.title}</h5>
                    <div class="space-y-1 mb-3">${optionsHtml}</div>
                    <button id="roll-${key}" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Lanzar D${data.options.length}</button>
                `;

                document.getElementById(`roll-${key}`).addEventListener('click', (e) => {
                    const button = e.target;
                    button.classList.add('dice-roll-animation');
                    setTimeout(() => button.classList.remove('dice-roll-animation'), 500);

                    const options = container.querySelectorAll('.dice-option');
                    options.forEach(opt => opt.classList.remove('selected'));
                    const roll = Math.floor(Math.random() * data.options.length);
                    options[roll].classList.add('selected');
                    selections[key] = data.options[roll];
                    updateRutaResumen();
                });
            });
            
            const exportBtn = document.getElementById('exportTallerPdfBtn');
            const cardToExport = document.querySelector("#taller .taller-card");
            if (exportBtn && cardToExport) {
                exportBtn.onclick = () => {
                    const { jsPDF } = window.jspdf;
                    exportBtn.style.display = 'none'; // Hide button for screenshot

                    html2canvas(cardToExport, { backgroundColor: '#111827', scale: 2, windowHeight: cardToExport.scrollHeight }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        const imgWidth = canvas.width;
                        const imgHeight = canvas.height;
                        const ratio = imgHeight / imgWidth;
                        const pdfHeight = pdfWidth * ratio;

                        let heightLeft = pdfHeight;
                        let position = 0;

                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                        heightLeft -= pageHeight;

                        while (heightLeft > 0) {
                            position = -heightLeft;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                            heightLeft -= pageHeight;
                        }
                        pdf.save("taller-ruta-del-cambio.pdf");
                        exportBtn.style.display = 'flex'; // Show button again
                    });
                };
            }
        }
        
        function loadFinal() {
            document.getElementById('final-content').innerHTML = courseContent.final;
        }

        function promptPassword(onSuccess) {
            passwordModal.classList.remove('hidden');
            setTimeout(() => passwordModal.classList.remove('opacity-0'), 10);
            passwordInput.value = '';
            passwordError.textContent = '';
            passwordInput.focus();

            const handleSubmit = () => {
                if (passwordInput.value === 'Comfa2025') {
                    onSuccess();
                    closeModal();
                } else {
                    passwordError.textContent = 'Contrase√±a incorrecta.';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            };

            const closeModal = () => {
                passwordModal.classList.add('opacity-0');
                setTimeout(() => passwordModal.classList.add('hidden'), 300);
                passwordSubmit.removeEventListener('click', handleSubmit);
                passwordInput.removeEventListener('keydown', handleKeydown);
                passwordCancel.removeEventListener('click', closeModal);
            };
            
            const handleKeydown = (e) => {
                if (e.key === 'Enter') handleSubmit();
            };

            passwordSubmit.addEventListener('click', handleSubmit);
            passwordCancel.addEventListener('click', closeModal);
            passwordInput.addEventListener('keydown', handleKeydown);
        }

        function toggleFullScreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            fullscreenBtn.innerHTML = `<i class="fas fa-compress text-xl"></i>`;
          } else if (document.exitFullscreen) {
            document.exitFullscreen();
            fullscreenBtn.innerHTML = `<i class="fas fa-expand text-xl"></i>`;
          }
        }

        fullscreenBtn.addEventListener('click', toggleFullScreen);

        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT' || !passwordModal.classList.contains('hidden')) {
                return;
            }
            if (e.key === 'ArrowRight' || e.key === 'PageDown' || e.key === ' ') {
                e.preventDefault();
                if (currentSlideIndex === 0) {
                     showSlide(1);
                } else if (currentSlideIndex < slides.length - 1) {
                    showSlide(currentSlideIndex + 1);
                }
            } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
                e.preventDefault();
                if (currentSlideIndex > 0) {
                    showSlide(currentSlideIndex - 1);
                }
            }
        });

        coverNextBtn.addEventListener('click', () => showSlide(1));
        nextBtn.addEventListener('click', () => { if (currentSlideIndex < slides.length - 1) showSlide(currentSlideIndex + 1); });
        prevBtn.addEventListener('click', () => { if (currentSlideIndex > 0) showSlide(currentSlideIndex - 1); });

        showSlide(0);
        
        // --- PLEXUS BACKGROUND ---
        const canvas = document.getElementById('plexus-bg');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = Math.random() * 0.4 - 0.2;
                this.vy = Math.random() * 0.4 - 0.2;
                this.radius = 2;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(56, 189, 248, 0.5)';
                ctx.fill();
            }
        }

        function initPlexus() {
            resizeCanvas();
            particles = [];
            let particleCount = Math.floor(canvas.width / 40);
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        function animatePlexus() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            connectParticles();
            requestAnimationFrame(animatePlexus);
        }

        function connectParticles() {
            for (let i = 0; i < particles.length; i++) {
                for (let j = i; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 120) {
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(56, 189, 248, ${1 - distance / 120})`;
                        ctx.lineWidth = 0.5;
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }
        }

        window.addEventListener('resize', initPlexus);
        initPlexus();
        animatePlexus();
    }
</script>
</body>
</html>




